/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package DatabaseMethods;

import DatabaseClasses.Geouser;
import java.util.ArrayList;
import java.util.List;
import javax.persistence.EntityManager;

/**
 * This class is the interface to manage the Database.
 *
 * @author Beatriz
 */
public class ManageToursDatabaseMethods {

    /**
     * This is needed for the Java Persistence.
     */
    private EntityManager em;

    /**
     * Constructor.
     * @param em1 em.
     */
    public ManageToursDatabaseMethods(final EntityManager em1) {
        this.em = em1;
    }

    /////////////////
    // GET Methods //
    /////////////////
    /**
     * Gets all tours.
     * @return all tours.
     */
    public final ArrayList<Model.Tour> getAllTours() {
        List<DatabaseClasses.Tour> dbTours = (List<DatabaseClasses.Tour>) em.
                createNamedQuery("Tour.findAll").getResultList();
        List<Model.Tour> mTours = new ArrayList<Model.Tour>();

        for (DatabaseClasses.Tour dbTour : dbTours) {
            mTours.add(passDBTourToModelTour(dbTour));
        }

        return (ArrayList<Model.Tour>) mTours;
    }

    /**
     * Get Tour by Id.
     * @param nTourId toud ID.
     * @return tour.
     */
    public final Model.Tour getTourById(final int nTourId) {
        DatabaseClasses.Tour dbTour = (DatabaseClasses.Tour) em.
                createNamedQuery("Tour.findByIdtour").
                setParameter("idtour", nTourId).getResultList().get(0);
        return passDBTourToModelTour(dbTour);
    }

    /**
     * Get waypoints by tour ID.
     * @param nTourId toud ID.
     * @return waypoints.
     */
    public final ArrayList<Model.Waypoint> getAllWaypointsByTourId(
            final int nTourId) {
        List<DatabaseClasses.Waypoint> dbWaypoints =
                (List<DatabaseClasses.Waypoint>) em.
                createNamedQuery("Waypoint.findByTourId").
                setParameter("tourId", nTourId).getResultList();
        ArrayList<Model.Waypoint> mWaypoints = new ArrayList<Model.Waypoint>();

        for (DatabaseClasses.Waypoint dbWaypoint : dbWaypoints) {
            Model.Waypoint mWaypoint =
                    passDBWaypointToModelWaypoint(dbWaypoint);
            mWaypoints.add(mWaypoint);
        }

        return mWaypoints;
    }

    /**
     * Get all questions by waypoint id.
     * @param nWaypointId waypoint id.
     * @return coordinate digits.
     */
    public final ArrayList<Model.Question> getAllQuestionsByWaypointId(
            final int nWaypointId) {
        List<DatabaseClasses.Question> dbQuestions =
                (List<DatabaseClasses.Question>) em.
                createNamedQuery("Question.findByWaypointIdwaypoint").
                setParameter("waypointIdwaypoint", nWaypointId).getResultList();
        ArrayList<Model.Question> mQuestions = new ArrayList<Model.Question>();

        for (DatabaseClasses.Question dbQuestion : dbQuestions) {
            Model.Question mQuestion =
                    passDBQuestionToModelQuestion(dbQuestion);
            mQuestions.add(mQuestion);
        }
        return mQuestions;
    }

    /**
     * Get all souvenirs by tour id.
     * @param nTourId tour id.
     * @return souvenirs.
     */
    public final ArrayList<Model.Souvenir> getAllSouvenirsByTourId(
            final int nTourId) {
        List<DatabaseClasses.Souvenir> dbSouvenirs =
                (List<DatabaseClasses.Souvenir>) em.
                createNamedQuery("Souvenir.findByTourId").
                setParameter("tourId", nTourId).getResultList();
        ArrayList<Model.Souvenir> mSouvenirs = new ArrayList<Model.Souvenir>();

        for (DatabaseClasses.Souvenir dbSouvenir : dbSouvenirs) {
            Model.Souvenir mSouvenir =
                    passDBSouvenirToModelSouvenir(dbSouvenir);
            mSouvenirs.add(mSouvenir);
        }
        return mSouvenirs;
    }

    ////////////////////
    // INSERT Methods //
    ////////////////////
    /**
     * Insert tour.
     * @param mTour tour.
     * @return tour ID.
     */
    public final int insertTour(final Model.Tour mTour) {
        int nLastTourId;
        try {
            nLastTourId = Integer.parseInt((em.createNamedQuery(
                    "Tour.getLastTourId").getResultList().get(0)).toString());
        } catch (Exception e) {
            nLastTourId = 0;
        }

        DatabaseClasses.Tour dbTour = new DatabaseClasses.Tour(nLastTourId + 1);
        dbTour = takeValuesFromModelTour(dbTour, mTour);

        Geouser dbUser = (Geouser) em.find(Geouser.class, mTour.getnUserId());
        dbTour.setUseridUser(dbUser);

        em.persist(dbTour);

        int nTourId = Integer.parseInt((em.createNamedQuery(
                "Tour.getLastTourId").getResultList().get(0)).toString());

        addOrEditWaypointsToTourId(nTourId, mTour.getTourWaypoints());
        addOrEditSouvenirsToTourId(nTourId, mTour.getTourSouvenirs());

        return nTourId;
    }

    /**
     * Insert waypoint to tour.
     * @param nTourId tour ID.
     * @param mWaypoint model waypoint.
     */
    private void insertWaypointToTour(
            final int nTourId, final Model.Waypoint mWaypoint) {
        int nLastWaypointId;
        try {
            nLastWaypointId = Integer.parseInt((em.
                    createNamedQuery("Waypoint.getLastWaypointId").
                    getResultList().get(0)).toString());
        } catch (Exception e) {
            nLastWaypointId = 0;
        }

        DatabaseClasses.Waypoint dbWaypoint =
                new DatabaseClasses.Waypoint(nLastWaypointId + 1);
        dbWaypoint = takeValuesFromModelWaypoint(dbWaypoint, mWaypoint);

        DatabaseClasses.Tour dbTour = (DatabaseClasses.Tour)
                em.find(DatabaseClasses.Tour.class, nTourId);
        dbWaypoint.setTourIdtour(dbTour);

        em.persist(dbWaypoint);

        int nWaypointId = Integer.parseInt((em.createNamedQuery(
                "Waypoint.getLastWaypointId").getResultList().get(0)).
                toString());

        addOrEditQuestionsToWaypointId(nWaypointId, mWaypoint.getQuestions());
    }

    /**
     * Insert Digit to Waypoint.
     * @param nWaypointId waypoint id.
     * @param mQuestion model mQuestion.
     */
    private void insertQuestionToWaypoint(final int nWaypointId,
            final Model.Question mQuestion) {

        DatabaseClasses.Question dbQuestion =
                new DatabaseClasses.Question(
                mQuestion.getDigitPosition(), nWaypointId);
        dbQuestion = takeValuesFromModelQuestion(dbQuestion, mQuestion);

        DatabaseClasses.Waypoint dbWaypoint = (DatabaseClasses.Waypoint)
                em.find(DatabaseClasses.Waypoint.class, nWaypointId);
        dbQuestion.setWaypoint(dbWaypoint);

        em.persist(dbQuestion);
    }

    /**
     * Insert souvenir to tour.
     * @param nTourId tour id.
     * @param mSouvenir souvenir.
     */
    private void insertSouvenirToTour(
            final int nTourId, final Model.Souvenir mSouvenir) {
        int nLastSouvenirId;
        try {
            nLastSouvenirId = Integer.parseInt((em.
                    createNamedQuery("Souvenir.getLastSouvenirId").
                    getResultList().get(0)).toString());
        } catch (Exception e) {
            nLastSouvenirId = 0;
        }

        DatabaseClasses.Souvenir dbSouvenir =
                new DatabaseClasses.Souvenir(nLastSouvenirId + 1);
        dbSouvenir = takeValuesFromModelSouvernir(dbSouvenir, mSouvenir);

        DatabaseClasses.Tour dbTour = (DatabaseClasses.Tour)
                em.find(DatabaseClasses.Tour.class, nTourId);
        dbSouvenir.setTourIdtour(dbTour);

        em.persist(dbSouvenir);
    }

    //////////////////
    // EDIT Methods //
    //////////////////
    /**
     * Edit tour.
     * @param nTourId tour id.
     * @param mTour model Tour.
     */
    public final void editTour(final int nTourId, final Model.Tour mTour) {

        DatabaseClasses.Tour dbTour =
                em.find(DatabaseClasses.Tour.class, nTourId);

        dbTour = takeValuesFromModelTour(dbTour, mTour);

        addOrEditWaypointsToTourId(nTourId, mTour.getTourWaypoints());
        deleteWaypointsByIdList(mTour.getRemovedWaypoints());
        addOrEditSouvenirsToTourId(nTourId, mTour.getTourSouvenirs());
        deleteSouvenirsByIdList(mTour.getRemovedSouvernirs());
    }

    private void addOrEditWaypointsToTourId(
            final int nTourId, final List<Model.Waypoint> mWaypoints) {

        for (Model.Waypoint mWaypoint : mWaypoints) {
            int nWaypointId = mWaypoint.getWaypointId();

            DatabaseClasses.Waypoint dbWaypoint =
                    em.find(DatabaseClasses.Waypoint.class, nWaypointId);

            if (dbWaypoint != null) {
                dbWaypoint = takeValuesFromModelWaypoint(dbWaypoint, mWaypoint);
                addOrEditQuestionsToWaypointId(
                		nWaypointId, mWaypoint.getQuestions());
            } else {
                insertWaypointToTour(nTourId, mWaypoint);
            }
        }
    }

    private void addOrEditQuestionsToWaypointId(
            final int nWaypointId, final List<Model.Question> mQuestions) {

        for (Model.Question mQuestion : mQuestions) {
            DatabaseClasses.Question dbQuestion =
                    em.find(DatabaseClasses.Question.class, new DatabaseClasses.
                    QuestionPK(mQuestion.getDigitPosition(), nWaypointId));

            if (dbQuestion != null) {
                dbQuestion = takeValuesFromModelQuestion(dbQuestion, mQuestion);
            } else {
                insertQuestionToWaypoint(nWaypointId, mQuestion);
            }
        }
    }

    private void addOrEditSouvenirsToTourId(
            final int nTourId, final List<Model.Souvenir> mTourSouvenirs) {

        for (Model.Souvenir mSouv : mTourSouvenirs) {
            DatabaseClasses.Souvenir dbSouvenir =
                    em.find(DatabaseClasses.Souvenir.class,
                    mSouv.getSouvenirid());

            if (dbSouvenir != null) {
                dbSouvenir = takeValuesFromModelSouvernir(dbSouvenir, mSouv);
            } else {
                insertSouvenirToTour(nTourId, mSouv);
            }
        }
    }

    ////////////////////
    // DELETE Methods //
    ////////////////////
    /**
     * Delete tour automatically deletes waypoints, coordinate digits, and
     * souvenirs related to that tour.
     * @param nTourId tour Id.
     */
    public final void deleteTourById(final int nTourId) {
        DatabaseClasses.Tour dbTour =
                em.find(DatabaseClasses.Tour.class, nTourId);

        if (dbTour != null) {
            em.remove(dbTour);
        }
    }

    private void deleteWaypointsByIdList(
    		final List<Integer> deletedWaypointIDs) {
        for (Integer deletedWaypointID : deletedWaypointIDs) {
            DatabaseClasses.Waypoint dbWaypointToDelete =
                    em.find(DatabaseClasses.Waypoint.class, deletedWaypointID);

            if (dbWaypointToDelete != null) {
                em.remove(dbWaypointToDelete);
            }
        }
    }

    private void deleteSouvenirsByIdList(
    		final List<Integer> removedSouvernirsIDs) {
        for (Integer deletedSouvenirsID : removedSouvernirsIDs) {
            DatabaseClasses.Souvenir dbSouvenirToDelete =
                    em.find(DatabaseClasses.Souvenir.class, deletedSouvenirsID);

            if (deletedSouvenirsID != null) {
                em.remove(dbSouvenirToDelete);
            }
        }
    }

    ///////////////////////
    // Interface Methods //
    ///////////////////////
    /**
     * Pass DB tour to Model tour.
     * @param dbTour DB tour.
     * @return model tour.
     */
    private Model.Tour passDBTourToModelTour(
            final DatabaseClasses.Tour dbTour) {
        Model.Tour mTour = new Model.Tour(
                dbTour.getIdtour(),
                dbTour.getName(),
                dbTour.getDescription(),
                dbTour.getDifficulty(),
                dbTour.getBadgeURL(),
                dbTour.getDistance(),
                dbTour.getUseridUser().getIdUser());

        for (DatabaseClasses.Waypoint dbWayp : dbTour.getWaypointCollection()) {
            Model.Waypoint mWaypoint = passDBWaypointToModelWaypoint(dbWayp);
            mTour.addWaypoint(mWaypoint);
        }

        return mTour;
    }

    /**
     * Take values from Model to DB: Tour.
     * @param dbTour DB tour.
     * @param mTour Model Tour.
     * @return DB tour.
     */
    private DatabaseClasses.Tour takeValuesFromModelTour(
            DatabaseClasses.Tour dbTour, final Model.Tour mTour) {
        dbTour.setName(mTour.getTourName());
        dbTour.setDescription(mTour.getTourDescription());
        dbTour.setDifficulty(mTour.getTourDifficulty());
        dbTour.setBadgeURL(mTour.getsBadgeURL());
        dbTour.setDistance(mTour.getsDistance());
        return dbTour;
    }

    /**
     * Pass DB waypoint to model waypoint.
     * @param dbWaypoint db waypoint.
     * @return mode waypoint.
     */
    private Model.Waypoint passDBWaypointToModelWaypoint(
            final DatabaseClasses.Waypoint dbWaypoint) {
        Model.Waypoint mWaypoint = new Model.Waypoint(
                dbWaypoint.getIdwaypoint(),
                dbWaypoint.getTourIdtour().getIdtour(),
                dbWaypoint.getName(),
                dbWaypoint.getLatitude(),
                dbWaypoint.getLongitude(),
                dbWaypoint.getOrderPosition());
        return mWaypoint;
    }

     /**
     * Take from model to DB: waypoint.
     * @param dbWayp DB waypoint.
     * @param mWaypoint model waypoint.
     * @return DB waypoint.
     */
    private DatabaseClasses.Waypoint takeValuesFromModelWaypoint(
            DatabaseClasses.Waypoint dbWayp, final Model.Waypoint mWaypoint) {
        dbWayp.setName(mWaypoint.getWaypointName());
        dbWayp.setLatitude(mWaypoint.getWaypointLatitude());
        dbWayp.setLongitude(mWaypoint.getWaypointLongitude());
        dbWayp.setOrderPosition(mWaypoint.getWaypointPosition());
        return dbWayp;
    }

    /**
     * Pass DB to Model Question.
     * @param dbQuestion DB Question.
     * @return model Question.
     */
    private Model.Question passDBQuestionToModelQuestion(
            final DatabaseClasses.Question dbQuestion) {
        Model.Question mCoordDigit = new Model.Question(
                dbQuestion.getQuestionPK().getDigitPosition(),
                dbQuestion.getQuestion(),
                dbQuestion.getQuestionPK().getWaypointIdwaypoint());
        return mCoordDigit;
    }

    /**
     * Take from model to DB: question.
     * @param dbQuestion db question.
     * @param mQuestion model question.
     * @return db question.
     */
    private DatabaseClasses.Question takeValuesFromModelQuestion(
            DatabaseClasses.Question dbQuestion,
            final Model.Question mQuestion) {
        dbQuestion.setQuestion(mQuestion.getQuestion());
        return dbQuestion;
    }

    /**
     * Pass DB to Model: Souvenir.
     * @param dbSouvenir DB souvenir.
     * @return model souvenir.
     */
    private Model.Souvenir passDBSouvenirToModelSouvenir(
            final DatabaseClasses.Souvenir dbSouvenir) {
        Model.Souvenir mSouvenir = new Model.Souvenir(
                dbSouvenir.getIdsouvenir(),
                dbSouvenir.getTourIdtour().getIdtour(),
                dbSouvenir.getSouvenirURL(),
                dbSouvenir.getDownloads());
        return mSouvenir;
    }

    /**
     * Take values from model to DB: Souvenir.
     * @param dbSouvenir DB souvenir.
     * @param mSouvenir Model souvenir.
     * @return DB souvenir.
     */
    private DatabaseClasses.Souvenir takeValuesFromModelSouvernir(
            DatabaseClasses.Souvenir dbSouvenir,
            final Model.Souvenir mSouvenir) {
        dbSouvenir.setSouvenirURL(mSouvenir.getSouvenirURL());
        dbSouvenir.setDownloads(mSouvenir.getDownloads());
        return dbSouvenir;
    }
}
